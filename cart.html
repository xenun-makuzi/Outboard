<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outboard Motors — Cart</title>
  
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root{
      --max:1200px; --accent:#ec407a; --bg:#f7f8fa; --card:#fff;
      --muted:#6b6b6b; --success:#27a844; --danger:#d32f2f;
      --shadow: 0 8px 28px rgba(18,24,32,0.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#111;}
    .container{max-width:var(--max);margin:20px auto;padding:16px}
    header{background:var(--card);border-bottom:1px solid #eee;padding:12px 16px;}
    .logo{font-weight:800;font-size:1.2rem;color:var(--accent);text-decoration:none}
    .cart-grid{display:grid;grid-template-columns:1fr 380px;gap:24px;}
    @media(max-width:960px){ .cart-grid{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:12px;padding:20px;border:1px solid #eee;box-shadow:var(--shadow)}
    .cart-item{display:flex;gap:16px;padding:16px 0;border-bottom:1px solid #f0f0f0;align-items:center}
    .item-img{width:100px;height:80px;border-radius:8px;object-fit:cover;background:#f9f9f9}
    .item-info{flex:1}
    .item-title{font-weight:700;display:block;margin-bottom:5px}
    .controls{display:flex;align-items:center;gap:12px;margin-top:10px}
    .qty-btn{width:28px;height:28px;border-radius:50%;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:bold}
    .remove-link{color:var(--danger);font-size:0.85rem;cursor:pointer;background:none;border:none;padding:0;font-weight:600}
    .price-col{text-align:right;min-width:110px}
    .summary-row{display:flex;justify-content:space-between;margin-bottom:12px}
    .grand-total{border-top:2px solid #eee;padding-top:12px;margin-top:12px;font-weight:900;font-size:1.3rem;color:var(--accent)}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;font-size:0.85rem;font-weight:600;margin-bottom:5px;color:var(--muted)}
    .form-group input, .form-group textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;font-family:inherit}
    .btn-block{width:100%;padding:14px;border-radius:10px;border:0;font-weight:700;cursor:pointer;transition:0.2s}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
    .promo-box{display:flex;gap:8px;margin-bottom:20px}
  </style>
</head>
<body>

  <header>
    <div class="container" style="display:flex; justify-content:space-between; margin:0 auto; padding:0 16px">
      <a href="./" class="logo">Outboard Motors</a>
      <nav><a href="shop.html" style="text-decoration:none; font-weight:600">Shop</a></nav>
    </div>
  </header>

  <main class="container">
    <h1>Your Shopping Cart</h1>
    <div class="cart-grid">
      <section>
        <div class="card" id="cart-items-container"></div>
        <button class="btn-block" id="clear-cart-btn" style="background:none; color:var(--muted); margin-top:10px">Clear Cart</button>
      </section>

      <aside>
        <div class="card">
          <h3 style="margin-top:0">Order Summary</h3>
          <div class="promo-box">
            <input type="text" id="promo-input" placeholder="Promo code (e.g. NEWGUY)" style="flex:1; padding:8px; border-radius:8px; border:1px solid #ddd">
            <button onclick="applyPromo()" style="padding:8px 12px; border-radius:8px; cursor:pointer; background:#eee; border:1px solid #ddd">Apply</button>
          </div>

          <div class="summary-row"><span>Subtotal</span><span id="subtotal-val">$0.00</span></div>
          <div class="summary-row" id="discount-row" style="display:none; color:var(--success)">
            <span>Discount (8%)</span><span id="discount-val">-$0.00</span>
          </div>
          <div class="summary-row"><span>Shipping</span><span id="shipping-val">$60.00</span></div>
          <div class="summary-row grand-total"><span>Total</span><span id="total-val">$0.00</span></div>
          
          <hr style="border:0;border-top:1px solid #eee;margin:20px 0">
          
          <h4>Delivery Information</h4>
          <div class="form-group"><label>Name</label><input type="text" id="c-name" placeholder="Full Name"></div>
          <div class="form-group"><label>Email</label><input type="email" id="c-email" placeholder="email@example.com"></div>
          <div class="form-group"><label>Phone</label><input type="tel" id="c-phone" placeholder="Phone Number"></div>
          <div class="form-group"><label>Notes</label><textarea id="c-notes" placeholder="Special instructions..."></textarea></div>

          <button class="btn-block btn-primary" id="proceed-btn">Proceed to payout</button>
        </div>
      </aside>
    </div>
  </main>

  <script>
    (function(){
      const CART_KEY = 'AQUAWAVE_cart';
      const ORDER_SNAPSHOT_KEY = 'AQUAWAVE_last_order'; // KEY FIX: Must match checkout.html
      let cart = [];
      let discountPercent = 0;

      const EMAILJS_USER_ID     = 'uxpve7I9VNOBYVeuT'; 
      const EMAILJS_SERVICE_ID  = 'Testing';           
      const EMAILJS_TEMPLATE_ID = 'Testing911';        

      const itemsContainer = document.getElementById('cart-items-container');
      const proceedBtn = document.getElementById('proceed-btn');

      function initFromStorage(){
        try {
          const raw = localStorage.getItem(CART_KEY);
          cart = raw ? JSON.parse(raw) : [];
        } catch(e){ cart = []; }
        render();
      }

      window.applyPromo = () => {
        const code = document.getElementById('promo-input').value.trim().toUpperCase();
        if(code === 'NEWGUY') {
          discountPercent = 0.08;
          alert('8% Discount Applied!');
        } else {
          discountPercent = 0;
          alert('Invalid promo code.');
        }
        render();
      };

      window.updateQty = (idx, delta) => {
        cart[idx].qty = Math.max(1, cart[idx].qty + delta);
        saveAndRender();
      };

      window.removeItem = (idx) => {
        if(confirm('Remove this item?')) {
          cart.splice(idx, 1);
          saveAndRender();
        }
      };

      function saveAndRender() {
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
        render();
      }

      function render(){
        if(cart.length === 0){
          itemsContainer.innerHTML = `<div style="text-align:center;padding:40px;color:var(--muted)">Your cart is empty.</div>`;
          updateTotals(0);
          return;
        }

        itemsContainer.innerHTML = cart.map((item, idx) => `
          <div class="cart-item">
            <img src="${item.image || 'https://placehold.co/100x80'}" class="item-img">
            <div class="item-info">
              <span class="item-title">${item.title}</span>
              <div class="controls">
                <button class="qty-btn" onclick="updateQty(${idx}, -1)">−</button>
                <span style="font-weight:bold">${item.qty}</span>
                <button class="qty-btn" onclick="updateQty(${idx}, 1)">+</button>
                <button class="remove-link" onclick="removeItem(${idx})" style="margin-left:15px">Delete</button>
              </div>
            </div>
            <div class="price-col">
              <strong style="font-size:1.1rem">$${(item.price * item.qty).toLocaleString()}</strong>
            </div>
          </div>
        `).join('');

        const subtotal = cart.reduce((acc, it) => acc + (it.price * it.qty), 0);
        updateTotals(subtotal);
      }

      function updateTotals(subtotal){
        const discountAmt = subtotal * discountPercent;
        const shipping = (subtotal >= 1000 || subtotal === 0) ? 0 : 60;
        const total = (subtotal - discountAmt) + shipping;

        document.getElementById('subtotal-val').innerText = '$' + subtotal.toLocaleString();
        document.getElementById('shipping-val').innerText = '$' + shipping.toLocaleString();
        document.getElementById('total-val').innerText = '$' + total.toLocaleString();

        const discRow = document.getElementById('discount-row');
        if(discountAmt > 0) {
          discRow.style.display = 'flex';
          document.getElementById('discount-val').innerText = '-$' + discountAmt.toLocaleString();
        } else {
          discRow.style.display = 'none';
        }
      }

      async function proceedToCheckout() {
        if (!cart.length) return alert('Cart is empty.');
        
        const name = document.getElementById('c-name').value.trim();
        const email = document.getElementById('c-email').value.trim();
        const phone = document.getElementById('c-phone').value.trim();
        const notes = document.getElementById('c-notes').value.trim();

        if (!name || !email || !phone) return alert('Please fill in Name, Email and Phone.');

        const subtotal = cart.reduce((acc, it) => acc + (it.price * it.qty), 0);
        const discountAmt = subtotal * discountPercent;
        const shipping = (subtotal >= 1000) ? 0 : 60;
        const grand = (subtotal - discountAmt) + shipping;

        // SAVE DATA FOR CHECKOUT.HTML
        const orderData = {
          email, tel: phone, name,
          cart: cart.map(it => ({ name: it.title, qty: it.qty, price: it.price, priceLabel: '$' + it.price.toLocaleString() })),
          subtotal, discount: discountAmt, shipping, grand, total: grand,
          createdAt: new Date().toISOString()
        };
        localStorage.setItem(ORDER_SNAPSHOT_KEY, JSON.stringify(orderData));

        try {
          proceedBtn.disabled = true;
          proceedBtn.innerText = 'Sending Order...';
          
          if (window.emailjs) {
            emailjs.init(EMAILJS_USER_ID);
            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
              from_name: name,
              from_email: email,
              customer_tel: phone,
              items_summary: cart.map((it, i) => `${i+1}. ${it.title} (x${it.qty})`).join('\n'),
              total: `$${grand.toLocaleString()}`
            });
            alert('Order Sent Successfully!');
            localStorage.removeItem(CART_KEY);
            window.location.href = 'checkout.html'; // REDIRECT FIX:
          }
        } catch (err) {
          console.error(err);
          alert('Email failed, but order saved locally. Redirecting...');
          window.location.href = 'checkout.html'; // REDIRECT FALLBACK FIX
        } finally {
          proceedBtn.disabled = false;
        }
      }

      document.getElementById('clear-cart-btn').onclick = () => { if(confirm('Clear cart?')) { localStorage.removeItem(CART_KEY); location.reload(); } };
      proceedBtn.onclick = proceedToCheckout;
      initFromStorage();
    })();
  </script>
</body>
</html>
